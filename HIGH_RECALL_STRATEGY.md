# High Recall Strategy - –ú–ê–®–ò–ù–ê 1

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** Cross-Encoder –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–ª–∏ –≤ TOP-N –æ—Ç bi-encoder.

**–†–µ—à–µ–Ω–∏–µ:**
- **–ú–ê–®–ò–ù–ê 1:** HIGH RECALL - –º–∞–∫—Å–∏–º—É–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (find ALL relevant docs)
- **–ú–ê–®–ò–ù–ê 2:** Cross-Encoder - —Ç–æ—á–Ω–æ–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ (rank them perfectly)
- **–ö–û–ú–ë–û:** High Recall + Cross-Encoder = –ú–ê–ö–°–ò–ú–£–ú!

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞

### 1. –ë–æ–ª—å—à–µ Embedders (Diversity)

**–ë–´–õ–û:**
```python
DOC_EMBEDDERS = {
    "e5_large": enabled,
    "sbert_ru": enabled,
    "mpnet": enabled,
    "labse": disabled,  # ‚Üê –í–´–ö–õ–Æ–ß–ï–ù
}
```

**–°–¢–ê–õ–û:**
```python
DOC_EMBEDDERS = {
    "e5_large": enabled (weight=2.5),
    "sbert_ru": enabled (weight=2.0),
    "mpnet": enabled (weight=1.8),
    "labse": enabled (weight=1.8),  # ‚Üê –í–ö–õ–Æ–ß–ï–ù!
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 4 –º–æ–¥–µ–ª–∏ –≤–º–µ—Å—Ç–æ 3 ‚Üí –±–æ–ª—å—à–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ ‚Üí –ª—É—á—à–µ recall

---

### 2. –ë–æ–ª—å—à–µ –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (Higher TOP_K)

**–ë–´–õ–û:**
```python
DOC_TOP_K_PER_EMBEDDER = 150
DOC_BM25_TOP_K = 200
CHUNK_TOP_K_PER_EMBEDDER = 100
CHUNK_BM25_TOP_K = 120
```

**–°–¢–ê–õ–û:**
```python
DOC_TOP_K_PER_EMBEDDER = 200  # +50
DOC_BM25_TOP_K = 250  # +50
CHUNK_TOP_K_PER_EMBEDDER = 150  # +50
CHUNK_BM25_TOP_K = 150  # +30
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª—å—à–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Üí –≤—ã—à–µ —à–∞–Ω—Å –Ω–∞–π—Ç–∏ –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ docs

---

### 3. –í—ã—à–µ BM25 –≤–µ—Å–∞

**–ë–´–õ–û:**
```python
BM25_DOC_WEIGHT = 2.0
BM25_CHUNK_WEIGHT = 1.7
```

**–°–¢–ê–õ–û:**
```python
BM25_DOC_WEIGHT = 2.5  # +0.5
BM25_CHUNK_WEIGHT = 2.0  # +0.3
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** BM25 —Ö–æ—Ä–æ—à–æ –Ω–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–ë–ò–ö, —Å—á–µ—Ç) ‚Üí —É–≤–µ–ª–∏—á–∏–ª–∏ –≤–µ—Å

---

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RRF

**–ë–´–õ–û:**
```python
RRF_K = 60
```

**–°–¢–ê–õ–û:**
```python
RRF_K = 70  # +10
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (4 embedders + BM25) –Ω—É–∂–µ–Ω –≤—ã—à–µ K –¥–ª—è –ª—É—á—à–µ–≥–æ fusion

---

## üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ Recall

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –ú–ê–®–ò–ù–ï 1 (HIGH RECALL):**
```
Doc-level:
  - e5_large_doc: TOP-200
  - sbert_ru_doc: TOP-200
  - mpnet_doc: TOP-200
  - labse_doc: TOP-200  ‚Üê –ù–û–í–´–ô!
  - bm25_doc: TOP-250

Chunk-level:
  - e5_large_chunk: TOP-150
  - bm25_chunk: TOP-150

= 7 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ √ó ~200 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ = ~1400 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
‚Üí RRF fusion ‚Üí TOP-200 unique docs
‚Üí –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —à–∞–Ω—Å —á—Ç–æ –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ docs –≤ —ç—Ç–∏—Ö TOP-200
```

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –ú–ê–®–ò–ù–ï 2 (Cross-Encoder):**
```
–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π config:
= 6 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ √ó ~150 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ = ~900 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
‚Üí RRF fusion ‚Üí TOP-100
‚Üí Cross-encoder rerank ‚Üí TOP-5
```

**–ö–û–ú–ë–û:**
```
–ú–ê–®–ò–ù–ê 1 (High Recall): TOP-200 (–≤—ã—Å–æ–∫–∏–π recall)
‚Üí Feed to Cross-Encoder
‚Üí Cross-Encoder: rerank TOP-200 ‚Üí TOP-5 (–∏–¥–µ–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)
```

---

## ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–ú–ê–®–ò–ù–ê 1 (High Recall):**
- –ï—Å–ª–∏ LaBSE –∏–Ω–¥–µ–∫—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç: ~35-40 –º–∏–Ω
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å LaBSE: +10 –º–∏–Ω = ~45-50 –º–∏–Ω

**–ü–æ—á–µ–º—É –¥–æ–ª—å—à–µ:**
- LaBSE encoding (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å)
- –ë–æ–ª—å—à–µ TOP_K (–±–æ–ª—å—à–µ –ø–æ–∏—Å–∫ –≤ FAISS)

**–ù–æ —ç—Ç–æ –û–ö!** - –í—ã—Å–æ–∫–∏–π recall —Å—Ç–æ–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö 5-10 –º–∏–Ω—É—Ç

---

## üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞ –ú–ê–®–ò–ù–ï 1

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏ Perfect Variants
pkill -9 -f generate_perfect_variant

# 2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ High Recall –≤–µ—Ç–∫—É
git checkout claude/high-recall-config-01PoWpmzz2iYpxUjuAZi7KmC
git pull

# 3. –ó–∞–ø—É—Å—Ç–∏
chmod +x run_high_recall.sh
nohup ./run_high_recall.sh &

# 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
tail -f search_high_recall.log
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ú–ê–®–ò–ù–ê 1 (High Recall) - Solo:

**Hit@5 = 0.34-0.36** (+3-5pp)

–ü–æ—á–µ–º—É –Ω–µ –≤—ã—à–µ:
- –í—ã—Å–æ–∫–∏–π recall ‚â† –≤—ã—Å–æ–∫–∞—è precision
- –ú–Ω–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ false positives –≤ TOP-5
- –ù–æ –í–°–ï –∏—Å—Ç–∏–Ω–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ docs —Ç–æ—á–Ω–æ –≤ TOP-N!

### –ú–ê–®–ò–ù–ê 2 (Cross-Encoder) - Solo:

**Hit@5 = 0.36-0.38** (+5-7pp)

### üî• –ö–û–ú–ë–û (High Recall + Cross-Encoder):

**Hit@5 = 0.38-0.40** (+7-9pp)

**–ü–æ—á–µ–º—É –∫–æ–º–±–æ –ª—É—á—à–µ:**
```
High Recall: "–ù–∞–π–¥–∏ –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ docs (–¥–∞–∂–µ —Å risk of false positives)"
Cross-Encoder: "–ò–∑ –≤—Å–µ—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤—ã–±–µ—Ä–∏ –¢–û–ß–ù–û —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ TOP-5"

= –õ—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –º–∏—Ä–æ–≤!
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–µ–π—á–∞—Å:** –ó–∞–ø—É—Å—Ç–∏ High Recall –Ω–∞ –ú–ê–®–ò–ù–ï 1 (~40 –º–∏–Ω)
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:** –ú–ê–®–ò–ù–ê 2 —É–∂–µ –¥–µ–ª–∞–µ—Ç Cross-Encoder (~20 –º–∏–Ω)
3. **–ß–µ—Ä–µ–∑ 20 –º–∏–Ω:** –ü–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ú–ê–®–ò–ù–´ 2 ‚Üí SUBMIT –µ—Å–ª–∏ —Ö–æ—Ä–æ—à–∏–π
4. **–ß–µ—Ä–µ–∑ 40 –º–∏–Ω:** –ü–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ú–ê–®–ò–ù–´ 1 ‚Üí SUBMIT –µ—Å–ª–∏ –ª—É—á—à–µ –ú–ê–®–ò–ù–´ 2
5. **–ö–û–ú–ë–û (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):** –ï—Å–ª–∏ –≤—Ä–µ–º—è –µ—Å—Ç—å, –æ–±—ä–µ–¥–∏–Ω–∏ –ª—É—á—à–∏–µ –Ω–∞—Ö–æ–¥–∫–∏

---

## üí° –ö–û–ú–ë–û Strategy (–µ—Å–ª–∏ –≤—Ä–µ–º—è –±—É–¥–µ—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç A: Ensemble Voting

–ë–µ—Ä–µ—à—å TOP-5 –æ—Ç –∫–∞–∂–¥–æ–π –º–∞—à–∏–Ω—ã:
```python
votes = {}
for doc in top5_machine1 + top5_machine2:
    votes[doc] = votes.get(doc, 0) + 1

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–æ–≤
final_top5 = sorted(votes.items(), key=lambda x: -x[1])[:5]
```

### –í–∞—Ä–∏–∞–Ω—Ç B: Feed High Recall ‚Üí Cross-Encoder

```python
# –ù–∞ –ú–ê–®–ò–ù–ï 2:
# 1. –°–∫–æ–ø–∏—Ä—É–π submit_HIGH_RECALL.csv —Å –ú–ê–®–ò–ù–´ 1
# 2. –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ docs –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è Cross-Encoder
# 3. Cross-Encoder –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç –∏—Ö ‚Üí –∏–¥–µ–∞–ª—å–Ω—ã–π TOP-5
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

**LaBSE –∏–Ω–¥–µ–∫—Å—ã:**
- –ï—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç ‚Üí —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç (~10 –º–∏–Ω)
- –ò–ª–∏ –ø–æ—Å—Ç—Ä–æ–π –∑–∞—Ä–∞–Ω–µ–µ: `python scripts/02_build_indices.py`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
ls -lh data/indices/labse_doc.bin
ls -lh data/embeddings/labse_doc.npy
```

–ï—Å–ª–∏ —Ñ–∞–π–ª—ã –µ—Å—Ç—å ‚Üí —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–π –ø–æ–∏—Å–∫ (35 –º–∏–Ω)
–ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–∫—Ä–∏–ø—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç (45 –º–∏–Ω)

---

**–í–†–ï–ú–Ø:** –£ —Ç–µ–±—è 3+ —á–∞—Å–∞ ‚Üí —É—Å–ø–µ–µ—à—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ö–û–ú–ë–û —Å–æ–±—Ä–∞—Ç—å! üöÄ
