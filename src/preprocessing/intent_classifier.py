"""
Rule-based intent classification для банковских запросов.
"""
import re
from typing import Set, List


class IntentClassifier:
    """Классификация интентов в запросах."""

    # Паттерны для каждого интента
    INTENT_PATTERNS = {
        "БИК": [
            r'\bбик\b',
            r'\bbik\b',
            r'банковский\s+идентификационный\s+код',
        ],
        "РАСЧЕТНЫЙ_СЧЕТ": [
            r'расчетн[ыо]й\s+счет',
            r'расчётн[ыо]й\s+счёт',
            r'\bр\s*/\s*с\b',
            r'\bрс\b',
            r'реквизит',
        ],
        "КОРР_СЧЕТ": [
            r'корреспондентск',
            r'корр\s+счет',
            r'\bк\s*/\s*с\b',
        ],
        "СМС_ПРОБЛЕМЫ": [
            r'не\s+приходит\s+sms',
            r'не\s+приходят\s+sms',
            r'sms\s+не\s+приходит',
            r'не\s+получа(?:ю|ет|ем)\s+sms',
            r'код\s+подтверждени[ея]\s+не\s+приходит',
            r'проблем[аы]\s+(?:с|со)\s+sms',
        ],
        "СМС_НАСТРОЙКА": [
            r'настро[йи](?:ть|ка)\s+sms',
            r'подключить\s+sms',
            r'отключить\s+sms',
            r'sms\s+уведомлени[ея]',
        ],
        "ЗАРПЛАТА": [
            r'зарплат',
            r'\bз\s*/\s*п\b',
            r'\bзп\b',
            r'зарплатн[аы]я\s+карта',
            r'зарплатн[аы]й\s+счет',
            r'зарплатн[аы]й\s+проект',
        ],
        "КРЕДИТ": [
            r'кредит',
            r'кредитка',
            r'рассрочк',
            r'займ',
            r'ссуд[аы]',
        ],
        "ИПОТЕКА": [
            r'ипотек',
            r'жилищн[аы]й\s+кредит',
        ],
        "БЛОКИРОВКА": [
            r'заблокиро',
            r'блокиров',
            r'разблокиро',
        ],
        "АЛЬФА_ОНЛАЙН": [
            r'альфа_онлайн',
            r'альфа\s+онлайн',
            r'мобильн[ое]\s+приложени',
            r'интернет[\s\-]?банк',
            r'личн[ыо]й\s+кабинет',
        ],
        "ПЕРЕВОДЫ": [
            r'перевод',
            r'перевести',
            r'переслать',
            r'отправить\s+деньги',
        ],
        "КАРТА": [
            r'карт[аоы]',
            r'дебетов',
            r'кредитн[ая]\s+карта',
        ],
        "ВКЛАД": [
            r'вклад',
            r'депозит',
            r'накопительн',
        ],
    }

    def __init__(self):
        # Компилируем паттерны
        self.compiled_patterns = {
            intent: [re.compile(pattern, re.IGNORECASE) for pattern in patterns]
            for intent, patterns in self.INTENT_PATTERNS.items()
        }

    def classify(self, text: str) -> Set[str]:
        """
        Определяет интенты в тексте.

        Args:
            text: Текст для классификации

        Returns:
            Set интентов (может быть несколько)
        """
        if not isinstance(text, str) or not text:
            return set()

        intents = set()

        for intent, patterns in self.compiled_patterns.items():
            for pattern in patterns:
                if pattern.search(text):
                    intents.add(intent)
                    break  # Один паттерн нашелся - достаточно

        return intents

    def has_intent(self, text: str, intent: str) -> bool:
        """Проверяет наличие конкретного интента."""
        return intent in self.classify(text)

    def get_intent_keywords(self, intent: str) -> List[str]:
        """Возвращает ключевые слова для интента (для query expansion)."""
        keywords_map = {
            "БИК": ["bik", "банковский идентификационный код", "реквизиты"],
            "РАСЧЕТНЫЙ_СЧЕТ": ["расчетный_счет", "реквизиты", "счет организации"],
            "КОРР_СЧЕТ": ["корр_счет", "корреспондентский"],
            "СМС_ПРОБЛЕМЫ": ["sms", "код подтверждения", "не приходит"],
            "СМС_НАСТРОЙКА": ["sms", "уведомления", "настройка"],
            "ЗАРПЛАТА": ["зарплата", "зарплатный проект"],
            "КРЕДИТ": ["кредит", "кредитная карта", "рассрочка"],
            "ИПОТЕКА": ["ипотека", "жилищный кредит"],
            "БЛОКИРОВКА": ["блокировка", "заблокировать"],
            "АЛЬФА_ОНЛАЙН": ["альфа_онлайн", "мобильное приложение"],
            "ПЕРЕВОДЫ": ["перевод", "платеж"],
            "КАРТА": ["карта", "дебетовая"],
            "ВКЛАД": ["вклад", "депозит"],
        }
        return keywords_map.get(intent, [])


# Глобальный классификатор
_classifier = None

def classify_intent(text: str) -> Set[str]:
    """Глобальная функция для классификации интентов."""
    global _classifier
    if _classifier is None:
        _classifier = IntentClassifier()
    return _classifier.classify(text)
