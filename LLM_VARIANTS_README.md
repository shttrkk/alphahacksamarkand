# üöÄ LLM Query Variants - Egor's Killer Feature

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Ç–æ–ª–æ–∫ ~0.31 Hit@5 —Å–≤—è–∑–∞–Ω —Å —Ç–µ–º, —á—Ç–æ –º–Ω–æ–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã "—Å–ª–æ–º–∞–Ω—ã" –¥–ª—è retrieval:
- –°–ª–µ–Ω–≥: "–±–∞–±–∫–∏", "–∫—Ä–µ–¥–∏—Ç–∫–∞", "–∞–ø–ø"
- –û–ø–µ—á–∞—Ç–∫–∏ –∏ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã: "–¥–µ–Ω—å–≥–∏ –±–∞–Ω–∫"
- –ù–µ—è–≤–Ω—ã–π —Å–º—ã—Å–ª

**–†–µ—à–µ–Ω–∏–µ:** LLM-based query rewriting
- –û—Ñ–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 2-3 –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Qwen2.5-7B-Instruct (7B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –æ—Ç–ª–∏—á–Ω—ã–π —Ä—É—Å—Å–∫–∏–π)
- Multi-query retrieval —Å weighted RRF fusion

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** +5-10pp (0.31 ‚Üí 0.36-0.41) üéØ

---

## üèÉ Quick Start

### 1. –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (2-3 –º–∏–Ω—É—Ç—ã)

–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ 100 –∑–∞–ø—Ä–æ—Å–∞—Ö:

```bash
./test_llm_generation.sh
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –≤—ã–≤–æ–¥–µ.

### 2. –ü–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (2-3 —á–∞—Å–∞)

–ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é:

```bash
./run_llm_generation.sh
```

**–í–ê–ñ–ù–û:**
- –¢—Ä–µ–±—É–µ—Ç—Å—è GPU (RTX 4090 –∏–ª–∏ –∞–Ω–∞–ª–æ–≥ —Å 24GB+ VRAM)
- –í—Ä–µ–º—è: ~2-3 —á–∞—Å–∞ –¥–ª—è 7000 –∑–∞–ø—Ä–æ—Å–æ–≤
- –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 500 –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å)

### 3. –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–∏—Å–∫ –∫–∞–∫ –æ–±—ã—á–Ω–æ:

```bash
python scripts/03_run_search.py
```

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ `config/settings.py`:
- `USE_QUERY_VARIANTS = True`
- `ORIGINAL_QUERY_WEIGHT = 1.0`
- `VARIANT_QUERY_WEIGHT = 0.7`

---

## üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

### –í `config/settings.py`:

```python
# –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å LLM variants
USE_QUERY_VARIANTS = True

# –í–µ—Å–∞ –¥–ª—è RRF fusion
ORIGINAL_QUERY_WEIGHT = 1.0  # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–±–∞–∑–æ–≤—ã–π –≤–µ—Å)
VARIANT_QUERY_WEIGHT = 0.7   # LLM –≤–∞—Ä–∏–∞–Ω—Ç—ã (—á—É—Ç—å –º–µ–Ω—å—à–µ)

# –°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
MAX_VARIANTS_TO_USE = 2  # 1-3
```

### –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤ `tools/generate_query_variants.py`):

```python
LLM_MODEL_NAME = "Qwen/Qwen2.5-7B-Instruct"
LLM_NUM_VARIANTS = 2  # –°–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
LLM_BATCH_SIZE = 8    # Batch size (–¥–ª—è RTX 4090)
LLM_MAX_NEW_TOKENS = 80
LLM_TEMPERATURE = 0.7
```

---

## üîß –¢—é–Ω–∏–Ω–≥

### –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

1. –í `config/settings.py`:
   ```python
   MAX_VARIANTS_TO_USE = 3  # –í–º–µ—Å—Ç–æ 2
   ```

2. –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (–∏–ª–∏ –µ—Å–ª–∏ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏ —Å `num_variants=2`, –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å)

### –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤–µ—Å–∞:

–í `config/settings.py`:
```python
ORIGINAL_QUERY_WEIGHT = 1.0
VARIANT_QUERY_WEIGHT = 0.8  # –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
```

**–ù–ï** –Ω—É–∂–Ω–æ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ search.

### –ï—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–ª–æ—Ö–æ–µ:

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–ø—Ç –≤ `tools/generate_query_variants.py` (—Å—Ç—Ä–æ–∫–∞ 33: `SYSTEM_PROMPT`)
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç: `./test_llm_generation.sh`
3. –ï—Å–ª–∏ –û–ö, –ø–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: `./run_llm_generation.sh`

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
alpha_hack_v2/
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îî‚îÄ‚îÄ generate_query_variants.py  ‚Üê –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ data/processed/
‚îÇ   ‚îî‚îÄ‚îÄ query_variants.parquet      ‚Üê –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Å–æ–∑–¥–∞–µ—Ç—Å—è)
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ settings.py                 ‚Üê –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ 03_run_search.py            ‚Üê –ü–æ–∏—Å–∫ (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)
‚îÇ
‚îú‚îÄ‚îÄ run_llm_generation.sh           ‚Üê Launcher –¥–ª—è –ø–æ–ª–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test_llm_generation.sh          ‚Üê Launcher –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
‚îî‚îÄ‚îÄ LLM_VARIANTS_README.md          ‚Üê –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üêõ Troubleshooting

### "CUDA out of memory"

–£–º–µ–Ω—å—à–∏—Ç–µ batch size –≤ `run_llm_generation.sh`:
```bash
--batch_size 4  # –í–º–µ—Å—Ç–æ 8
```

### "Query variants file not found"

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é:
```bash
./run_llm_generation.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Falling back")

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: `ls -lh data/processed/query_variants.parquet`
2. `USE_QUERY_VARIANTS = True` –≤ `config/settings.py`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ search

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–ª–∞—Å—å

–ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
./run_llm_generation.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint.

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

–í–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ):

```bash
# –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ checkpoint
watch -n 5 'ls -lh data/processed/query_variants_checkpoint.parquet'

# GPU utilization
watch -n 1 nvidia-smi
```

---

## üéì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### 1. –û—Ñ–ª–∞–π–Ω (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)

```
Qwen2.5-7B-Instruct (4-bit quantized)
‚îÇ
‚îú‚îÄ Input: "–±–∞–±–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É —Å—Ä–æ—á–Ω–æ"
‚îÇ
‚îî‚îÄ Output:
   ‚îú‚îÄ "–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫—É—é –∫–∞—Ä—Ç—É –¥–µ–Ω—å–≥–∞–º–∏"
   ‚îî‚îÄ "–°—Ä–æ—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Ä—Ç—ã"
```

–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `query_variants.parquet`.

### 2. –û–Ω–ª–∞–π–Ω (–ø–æ–∏—Å–∫)

```
Query: "–±–∞–±–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É —Å—Ä–æ—á–Ω–æ" (q_id=123)
‚îÇ
‚îú‚îÄ Lookup variants: query_variants.parquet[q_id=123]
‚îÇ  ‚îú‚îÄ Original: "–±–∞–±–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É —Å—Ä–æ—á–Ω–æ" (weight=1.0)
‚îÇ  ‚îú‚îÄ Variant 1: "–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å..." (weight=0.7)
‚îÇ  ‚îî‚îÄ Variant 2: "–°—Ä–æ—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ..." (weight=0.7)
‚îÇ
‚îú‚îÄ Multi-query retrieval:
‚îÇ  ‚îú‚îÄ Search(original) ‚Üí candidates_1
‚îÇ  ‚îú‚îÄ Search(variant_1) ‚Üí candidates_2
‚îÇ  ‚îî‚îÄ Search(variant_2) ‚Üí candidates_3
‚îÇ
‚îú‚îÄ Weighted RRF fusion:
‚îÇ  ‚îî‚îÄ Combine with weights ‚Üí final_ranking
‚îÇ
‚îî‚îÄ Return TOP-5
```

### 3. RRF Weighting

–ö–∞–∂–¥—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤–µ—Å:
```python
weight = base_weight √ó variant_weight

–ù–∞–ø—Ä–∏–º–µ—Ä:
- E5 model on original query: 2.7 √ó 1.0 = 2.7
- E5 model on variant 1: 2.7 √ó 0.7 = 1.89
- BM25 on original: 2.3 √ó 1.0 = 2.3
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –∏–º–µ—Ç—å –±–æ–ª—å—à–∏–π –≤–µ—Å, –Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –≤–Ω–æ—Å—è—Ç –≤–∫–ª–∞–¥.

---

## üî¨ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã

### A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Å–æ–≤

```bash
# Baseline (–±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
USE_QUERY_VARIANTS=False python scripts/03_run_search.py

# Variant 1 (–æ—Ä–∏–≥–∏–Ω–∞–ª –≤–∞–∂–Ω–µ–µ)
ORIGINAL_QUERY_WEIGHT=1.0 VARIANT_QUERY_WEIGHT=0.5

# Variant 2 (balanced)
ORIGINAL_QUERY_WEIGHT=1.0 VARIANT_QUERY_WEIGHT=0.7

# Variant 3 (–≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–∞–∂–Ω–µ–µ)
ORIGINAL_QUERY_WEIGHT=1.0 VARIANT_QUERY_WEIGHT=1.0
```

–°—Ä–∞–≤–Ω–∏—Ç–µ Hit@5 –Ω–∞ leaderboard.

---

## üí° –°–æ–≤–µ—Ç—ã

1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `test_llm_generation.sh` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
2. **–î–æ–ª–≥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:** –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ –Ω–æ—á—å —Å `nohup`:
   ```bash
   nohup ./run_llm_generation.sh > llm_generation.log 2>&1 &
   ```
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏: `tail -f llm_generation.log`
4. **–¢—é–Ω–∏–Ω–≥ –≤–µ—Å–æ–≤:** –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Äî –º–µ–Ω—è–π—Ç–µ –≤ config –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–π—Ç–µ search

---

## ‚úÖ Checklist

- [ ] GPU –¥–æ—Å—Ç—É–ø–µ–Ω (nvidia-smi —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] –í–æ–ø—Ä–æ—Å—ã preprocessed (`data/raw/questions_clean.csv` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- [ ] –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω (`./test_llm_generation.sh`)
- [ ] –ü–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (`./run_llm_generation.sh`)
- [ ] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω (`data/processed/query_variants.parquet`)
- [ ] –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω (`python scripts/03_run_search.py`)
- [ ] Submission —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] Submit –Ω–∞ leaderboard! üöÄ

---

**–£–¥–∞—á–∏! –ü—Ä–æ—Ä–≤–µ–º—Å—è –∫ 0.40+!** üí™
